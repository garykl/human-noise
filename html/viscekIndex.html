<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <title>Swarming?</title>

    <!-- external libraries -->
    <script src='../client/ramda.js' type='text/javascript'></script>
    <script src='../client/svg.js' type='text/javascript'></script>

    <!-- convert model to visualization -->
    <script src='../client/realize.js' type='text/javascript'></script>
    <!-- prepare websocket connections behavior -->
    <script src="../client/client.js" type='text/javascript'></script>
    <!-- interface the message sending to the server for humans and viscek clients -->
    <script src="../client/sender.js" type='text/javascript'></script>

  </head>

  <body>
    <div id="content"></div>

    <script type='text/javascript'>


var initializeWebsocket = function (url) {
  window.WebSocket = window.WebSocket || window.MozWebSocket;
  if (!window.WebSocket) {
    content.innerHTML = '<p>Sorry, but your browser doesn\'t support WebSockets.';
    return undefined;
  }

  websocket = new WebSocket(url);
  return websocket;
}


var initializeUI = function () {

  var size = 600;

  var textContainer = document.getElementById('content');
  var svgns = 'http://www.w3.org/2000/svg';

  var svgContainer = document.createElementNS(svgns, 'svg');
  svgContainer.setAttribute('width', size);
  svgContainer.setAttribute('height', size);
  var background = svg.rectangle(size, size, { fill: '#333333' });
  svgContainer.appendChild(background);
  textContainer.appendChild(svgContainer);

  return modelBuilder(size, textContainer, svgContainer);

};

// include graphics library
var svg = SVG();

// prepare UI
var uiBuilder = initializeUI();

// start websocket
var connection = initializeWebsocket('ws://127.0.0.1:1337');


var maybe = function (func) {
  //: (a -> b) -> Maybe a -> Maybe b
    return function (a) {
      if (a === undefined) { return undefined; }
      return func(a);
    };
};


var currentState = (function () {
  var ids = [];
  var x = [];
  var y = [];
  var vx = [];
  var vy = [];

  var findIndex = maybe(function (cindix) {
    //: Integer -> Maybe Integer
    // cindex: the index send by the server.
    // return: the index of ids with value == cindex
    for (var i = 0; i < ids.length; i++) {
      if (cindix === ids[i]) {
        return i;
      }
    }
    return undefined;
  });

  var set = function (obj) {
    // obj: contains currentState like data.
    // resets the id and state variables.
    ids = obj.ids;
    x = obj.x;
    y = obj.y;
    vx = obj.vx;
    vy = obj.vy;
  };

  var getStateFromServerIndex = maybe(function (cindex) {
    //: Integer -> State of one agent
    if (findIndex(cindex) === undefined) { return undefined; }
    return {
      id: ids[findIndex(cindex)],
      x: x[findIndex(cindex)],
      y: y[findIndex(cindex)],
      vx: vx[findIndex(cindex)],
      vy: vy[findIndex(cindex)]
    }
  });


  var getState = function () {
    return {
      ids: ids,
      x: x,
      y: y,
      vx: vx,
      vy: vy
    };
  };


  return {
    set: set,
    getStateFromServerIndex: getStateFromServerIndex,
    getState: getState
  }

})();


var viscekCallback = function (index, json) {
  var messageTypes = ['spawned', 'viewport'];
  if (json.viewport !== undefined) {
    currentState.set(json['viewport']);
  }

  R.map(function (mt) {
    if (json[mt] !== undefined) {
      uiBuilder.drawAgents[mt](index, json[mt]);
    }
  }, messageTypes)

}


// connect the ui with the socket
var checkoutIndex = configureConnection(
    connection, viscekCallback, uiBuilder.onerror);

var stopSending = sender.viscekAgent(
    function () {
      console.log(checkoutIndex());
      return currentState.getStateFromServerIndex(checkoutIndex());
    },
    function () {
      return currentState.getState();
    }, connection);

    </script>
  </body>

</html>
