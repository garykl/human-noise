<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <title>Swarming?</title>

    <!-- functional library -->
    <script src='../client/ramda.js' type='text/javascript'></script>
    <!-- working with svg graphics -->
    <script src='../client/svg.js' type='text/javascript'></script>
    <!-- some useful, pure function -->
    <script src='../client/utils.js' type='text/javascript'></script>

    <!-- convert model to visualization -->
    <script src='../client/realize.js' type='text/javascript'></script>
    <!-- prepare websocket connections behavior -->
    <script src="../client/client.js" type='text/javascript'></script>
    <!-- interface the message sending to the server for humans and viscek clients -->
    <script src="../client/sender.js" type='text/javascript'></script>
    <!-- a structure for saving the state and interfacing with it -->
    <script src="../client/state.js" type='text/javascript'></script>
    <!-- collection of callback functions for use in configureConnection -->
    <script src="../client/configurations.js" type='text/javascript'></script>

  </head>

  <body>
    <div id="content"></div>
    <div>
      <button id='spawn'>Spawn!</button>
      <input type="text" id="number" value="1" />
    </div>

    <script type='text/javascript'>


var initializeWebsocket = function (url) {
  window.WebSocket = window.WebSocket || window.MozWebSocket;
  if (!window.WebSocket) {
    content.innerHTML = '<p>Sorry, but your browser doesn\'t support WebSockets.';
    return undefined;
  }

  websocket = new WebSocket(url);
  return websocket;
}


var initializeUI = function () {

  var size = 900;

  var textContainer = document.getElementById('content');
  var svgns = 'http://www.w3.org/2000/svg';

  var svgContainer = document.createElementNS(svgns, 'svg');
  svgContainer.setAttribute('width', size);
  svgContainer.setAttribute('height', size);
  var background = svg.rectangle(size, size, { fill: '#333333' });
  svgContainer.appendChild(background);
  textContainer.appendChild(svgContainer);

  return modelBuilder(size, textContainer, svgContainer);

};

// include graphics library
var svg = SVG();

// prepare UI
var uiBuilder = initializeUI();

// start websocket
var spawnViscekAgent = function () {

  var connection = initializeWebsocket('ws://127.0.0.1:1337');

  var currentState = state();

  // connect the ui with the socket
  var checkoutIndex = configureSubjectiveConnection(
      connection,
      viewportStateSaveCallback(currentState),
      uiBuilder.onerror);

  var stopSending = sender.viscekAgent(

      function () {
        return currentState.getStateFromServerIndex(checkoutIndex());
      },

      function () {
        return currentState.getState();
      },

      connection);
};


var observe = function () {

  var connection = initializeWebsocket('ws://127.0.0.1:1337');

  var currentState = state();

  // connect the ui with the socket
  configureObjectiveConnection(
      connection,
      sceneDrawCallback(currentState, uiBuilder),
      uiBuilder.onerror);
}


observe();
document.getElementById('spawn').onclick = function () {
  var num;
  try { num = Number(document.getElementById('number').value); }
  catch (e) { num = 1; }

  for (var i = 0; i < num; i++) {
    spawnViscekAgent();
  }
}

    </script>
  </body>

</html>
