<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <title>WebSockets - Simple chat</title>

    <!-- external libraries -->
    <script src='ramda.js' type='text/javascript'></script>
    <script src='svg.js' type='text/javascript'></script>

    <!-- convert model to visualization -->
    <script src='realize.js' type='text/javascript'></script>
    <!-- prepare websocket connections behavior -->
    <script src="client.js" type='text/javascript'></script>

  </head>

  <body>
    <div id="content"></div>
    <div>
      <input type="text" id="input"/>
    </div>

    <script type='text/javascript'>


var initializeWebsocket = function (url) {
  window.WebSocket = window.WebSocket || window.MozWebSocket;
  if (!window.WebSocket) {
    content.innerHTML = '<p>Sorry, but your browser doesn\'t support WebSockets.';
    return undefined;
  }

  websocket = new WebSocket(url);
  return websocket;
}


var initializeUI = function () {

  var textContainer = document.getElementById('content');
  var svgns = 'http://www.w3.org/2000/svg';

  var svgContainer = document.createElementNS(svgns, 'svg');
  svgContainer.setAttribute('width', 1000);
  svgContainer.setAttribute('height', 800);
  textContainer.appendChild(svgContainer);

  return modelBuilder(textContainer, svgContainer);

};

// include graphics library
var svg = SVG();

// prepare UI
var uiBuilder = initializeUI()

// start websocket
var connection = initializeWebsocket('ws://127.0.0.1:1337');

// connect the ui with the socket
configureConnection(connection, uiBuilder.drawAgents, uiBuilder.onerror);

// send messages
var accelerationSender = function (connection) {
  var keydown = false;

  var sendAcceleration = function (acceleration) {
    //if (keyTimer !== undefined) {
      //clearInterval(keyTimer);
    //}
    //keyTimer = setInterval(function () {
    if (!keydown) { connection.send(acceleration + ''); }
    //}, 100)
  }

  document.onkeydown = function(e) {

      // Left arrow key
      if (e.keyCode === 37) { sendAcceleration(-1); }
      // Right arrow key
      if (e.keyCode === 39) { sendAcceleration(1); }

      keydown = true;
  };

  document.onkeyup = function (e) {
    //clearInterval(keyTimer);
    keydown = false;
    if (e.keyCode === 37) { sendAcceleration(1); }
    if (e.keyCode === 39) { sendAcceleration(-1); }
  }

  var stopSending = function () {
    document.onkeydown = undefined;
    document.onkeyup = undefined;
    if (keyTimer !== undefined) {
      clearInterval(keyTimer);
    }
  }

  return stopSending;
}


var stopSending = accelerationSender(connection);

    </script>
  </body>

</html>
